


<!DOCTYPE html>
<html id="htmlId">
<head>
  <title>Coverage Report > WebSocketController</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">ch.uzh.ifi.hase.soprafs23.controller</a>
</div>

<h1>Coverage Summary for Class: WebSocketController (ch.uzh.ifi.hase.soprafs23.controller)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">WebSocketController</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (10/10)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    98.6%
  </span>
  <span class="absValue">
    (72/73)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package ch.uzh.ifi.hase.soprafs23.controller;
&nbsp;
&nbsp;import ch.uzh.ifi.hase.soprafs23.MultipleMode.Game;
&nbsp;import ch.uzh.ifi.hase.soprafs23.MultipleMode.Player;
&nbsp;import ch.uzh.ifi.hase.soprafs23.MultipleMode.Room;
&nbsp;import ch.uzh.ifi.hase.soprafs23.entity.User;
&nbsp;import ch.uzh.ifi.hase.soprafs23.questionGenerator.QuestionPacker;
&nbsp;import ch.uzh.ifi.hase.soprafs23.questionGenerator.question.CSVService;
&nbsp;import ch.uzh.ifi.hase.soprafs23.questionGenerator.question.DTO.QuestionDTO;
&nbsp;import ch.uzh.ifi.hase.soprafs23.service.GameService;
&nbsp;import ch.uzh.ifi.hase.soprafs23.service.UserService;
&nbsp;import ch.uzh.ifi.hase.soprafs23.websocket.dto.*;
&nbsp;import org.slf4j.Logger;
&nbsp;import org.slf4j.LoggerFactory;
&nbsp;import org.springframework.beans.factory.annotation.Autowired;
&nbsp;import org.springframework.messaging.handler.annotation.DestinationVariable;
&nbsp;import org.springframework.messaging.handler.annotation.MessageMapping;
&nbsp;import org.springframework.messaging.handler.annotation.SendTo;
&nbsp;import org.springframework.messaging.simp.SimpMessagingTemplate;
&nbsp;import org.springframework.messaging.simp.annotation.SubscribeMapping;
&nbsp;import org.springframework.web.bind.annotation.RestController;
&nbsp;
&nbsp;import java.util.LinkedHashMap;
&nbsp;import java.util.List;
&nbsp;import java.util.Map;
&nbsp;
&nbsp;@RestController
&nbsp;public class WebSocketController {
<b class="fc">&nbsp;    Logger log = LoggerFactory.getLogger(WebSocketController.class);</b>
&nbsp;    private final UserService userService;
&nbsp;    private final GameService gameService;
&nbsp;
&nbsp;    @Autowired
&nbsp;    private SimpMessagingTemplate simpMessagingTemplate;
&nbsp;
&nbsp;    @Autowired
&nbsp;    private CSVService csvService;
&nbsp;
<b class="fc">&nbsp;    public WebSocketController(UserService userService, GameService gameService, SimpMessagingTemplate simpMessagingTemplate) {</b>
<b class="fc">&nbsp;        this.userService = userService;</b>
<b class="fc">&nbsp;        this.gameService = gameService;</b>
<b class="fc">&nbsp;        this.simpMessagingTemplate = simpMessagingTemplate;</b>
<b class="fc">&nbsp;    }</b>
&nbsp;
&nbsp;//    @SubscribeMapping({ &quot;/greeting&quot;})
&nbsp;//    //&quot;/topic/greeting&quot;,
&nbsp;//    public String greet() throws Exception {
&nbsp;//        log.info(&quot;greeting subscribed&quot;);
&nbsp;//        return &quot;Hello, client!&quot;;
&nbsp;//    }
&nbsp;//
&nbsp;//    @SubscribeMapping(&quot;/multi/create/{userId}&quot;)
&nbsp;//    //&quot;/topic/greeting&quot;,
&nbsp;//    public String create() throws Exception {
&nbsp;//        log.info(&quot;creating subscribed&quot;);
&nbsp;//        return &quot;Hello, owner!&quot;;
&nbsp;//    }
&nbsp;
&nbsp;//    @SubscribeMapping(&quot;multi/rooms/{roomCode}/join&quot;)
&nbsp;//    //&quot;/topic/greeting&quot;,
&nbsp;//    public String join() throws Exception {
&nbsp;//        log.info(&quot;joining subscribed&quot;);
&nbsp;//        return &quot;Hello, player!&quot;;
&nbsp;//    }
&nbsp;
&nbsp;
&nbsp;    @MessageMapping(&quot;/multi/create/{userID}&quot;) //client.send(&quot;/app/muilti/create/userID&quot;,{}£¬JSON)
&nbsp;    //@SendTo(&quot;topic/multi/create/{userID}&quot;) //client.subscribe(&quot;topic/multi/create/{userID}&quot;)
&nbsp;    public void createRoom(@DestinationVariable int userID, GameParamDTO gameParam) throws Exception {
<b class="fc">&nbsp;        log.info(&quot;request to create new Room: &quot; + userID);</b>
&nbsp;        // client is a registered user
<b class="fc">&nbsp;        User gamer = userService.getUserById(userID);</b>
<b class="fc">&nbsp;        Player owner = gameService.createPlayer(gamer);</b>
<b class="fc">&nbsp;        Room newRoom = gameService.createRoom(owner, gameParam);</b>
<b class="fc">&nbsp;        log.info(&quot;new room created: &quot; + newRoom.getRoomCode());</b>
<b class="fc">&nbsp;        this.simpMessagingTemplate.convertAndSend(&quot;/topic/multi/create/&quot;+userID,newRoom);</b>
<b class="fc">&nbsp;        log.info(&quot;msg sent&quot;);</b>
<b class="fc">&nbsp;    }</b>
&nbsp;
&nbsp;    @MessageMapping(&quot;/multi/rooms/{roomID}/info&quot;) //client.send(&quot;/multi/rooms/&quot;+roomID+&quot;/info&quot;,{}£¬JSON)
&nbsp;    //@SendTo(&quot;topic/multi/rooms/{roomID}/info&quot;) //client.subscribe(&quot;topic/multi/rooms/&quot;+roomID+&quot;/info&quot;)
&nbsp;    public void getRoomByID(@DestinationVariable int roomID) throws Exception {
<b class="fc">&nbsp;        log.info(&quot;request to get room info: &quot; + roomID);</b>
<b class="fc">&nbsp;        Room foundRoom = this.gameService.findRoomByID(roomID);</b>
<b class="fc">&nbsp;        log.info(&quot;room found: &quot; + foundRoom.getRoomID());</b>
<b class="fc">&nbsp;        this.simpMessagingTemplate.convertAndSend(&quot;/topic/multi/rooms/&quot;+roomID+&quot;/info&quot;,foundRoom);</b>
&nbsp;        /**need to be corrected as user private channel*/
<b class="fc">&nbsp;        log.info(&quot;msg sent&quot;);</b>
<b class="fc">&nbsp;    }</b>
&nbsp;
&nbsp;    @MessageMapping(&quot;/multi/rooms/{roomCode}/join&quot;)
&nbsp;    public void joinRoom(@DestinationVariable String roomCode, PlayerDTO playerDTO) throws Exception {
<b class="fc">&nbsp;        log.info(&quot;request to join Room: &quot; + roomCode);</b>
<b class="fc">&nbsp;        Room foundRoom = this.gameService.findRoomByCode(roomCode);</b>
&nbsp;        // check if client is registered
&nbsp;        User gamer;
&nbsp;//        if (
&nbsp;//        this.userService.checkIfUserIDExists(playerDTO.getUserID());
&nbsp;//        ){
<b class="fc">&nbsp;        gamer = userService.getUserById(playerDTO.getUserID());</b>
&nbsp;//        } else {
&nbsp;//            gamer = new User();
&nbsp;//            gamer.setId(playerDTO.getUserID());
&nbsp;//            gamer.setUsername(playerDTO.getUserName());
&nbsp;//        }
<b class="fc">&nbsp;        Player player = gameService.createPlayer(gamer);</b>
<b class="fc">&nbsp;        if(!foundRoom.checkIsFull()) {</b>
<b class="fc">&nbsp;            foundRoom.addPlayer(player);</b>
&nbsp;        }
<b class="fc">&nbsp;        log.info(player.getPlayerName()+&quot; joined the room: &quot; + foundRoom.getRoomID());</b>
<b class="fc">&nbsp;        log.info(&quot;room contains &quot; + foundRoom.getPlayers().size() + &quot; players.&quot;);</b>
<b class="fc">&nbsp;        this.simpMessagingTemplate.convertAndSend(&quot;/topic/multi/rooms/&quot;+roomCode+&quot;/join&quot;,foundRoom);</b>
&nbsp;        /**need to be corrected as user private channel*/
<b class="fc">&nbsp;        this.simpMessagingTemplate.convertAndSend(&quot;/topic/multi/rooms/&quot;+foundRoom.getRoomID()+&quot;/info&quot;,foundRoom);</b>
<b class="fc">&nbsp;    }</b>
&nbsp;
&nbsp;    @MessageMapping(&quot;/multi/rooms/{roomID}/drop&quot;)
&nbsp;    public void dropRoom(@DestinationVariable int roomID, PlayerDTO playerDTO) throws Exception {
<b class="fc">&nbsp;        log.info(&quot;request to drop Room: &quot; + roomID);</b>
<b class="fc">&nbsp;        Room foundRoom = this.gameService.findRoomByID(roomID);</b>
<b class="fc">&nbsp;        Player player = foundRoom.findPlayerByUserID(playerDTO.getUserID());</b>
<b class="fc">&nbsp;        foundRoom.removePlayer(player);</b>
<b class="fc">&nbsp;        log.info(&quot;dropped from the room: &quot; + roomID);</b>
<b class="fc">&nbsp;        this.simpMessagingTemplate.convertAndSend(&quot;/topic/multi/rooms/&quot;+foundRoom.getRoomID()+&quot;/drop&quot;,foundRoom);</b>
<b class="fc">&nbsp;    }</b>
&nbsp;
&nbsp;    /**
&nbsp;     * Game start in two scenarios:
&nbsp;     * 1. Owner start the game, even not all players are ready;
&nbsp;     * 2. The server broadcast to clients when all players isReady=true;
&nbsp;     *
&nbsp;     * @throws Exception
&nbsp;     */
&nbsp;    @MessageMapping(&quot;/multi/games/{roomID}/start&quot;)
&nbsp;//  @SendTo(&quot;topic/multi/game/start&quot;)
&nbsp;    public void createGame(@DestinationVariable int roomID) throws Exception {
<b class="fc">&nbsp;        log.info(&quot;request to create game: &quot; + roomID);</b>
<b class="fc">&nbsp;        List&lt;QuestionDTO&gt; questionList = gameService.createGame(roomID,new QuestionPacker(csvService));</b>
<b class="fc">&nbsp;        log.info(&quot;new game created&quot;);</b>
<b class="fc">&nbsp;        this.simpMessagingTemplate.convertAndSend(&quot;/topic/multi/games/&quot;+roomID+&quot;/questions&quot;,questionList);</b>
<b class="fc">&nbsp;    }</b>
&nbsp;
&nbsp;    /**
&nbsp;     * It is used for update status when the player get ready: Set player isReady=true;
&nbsp;     *
&nbsp;     * @throws Exception
&nbsp;     */
&nbsp;    @MessageMapping(&quot;/multi/rooms/{roomID}/players/ready&quot;)
&nbsp;    public void updatePlayerReady(@DestinationVariable int roomID, PlayerStatusDTO playerStatusDTO) {
<b class="fc">&nbsp;        log.info(&quot;Room {}: Player {} is changing the status.&quot;, roomID, playerStatusDTO.getUserID());</b>
<b class="fc">&nbsp;        Player updatedPlayer = this.gameService.updatePlayerStatusReady(roomID, playerStatusDTO);</b>
&nbsp;
<b class="fc">&nbsp;        Room updatedRoom = this.gameService.findRoomByID(roomID);</b>
<b class="fc">&nbsp;        log.info(&quot;Updated room after player is ready: &quot; + updatedRoom.getRoomID());</b>
&nbsp;
<b class="fc">&nbsp;        boolean allReadyIndicator = this.gameService.checkALlReady(roomID);</b>
<b class="fc">&nbsp;        if(allReadyIndicator == true){</b>
<b class="nc">&nbsp;            log.info(&quot;Room {}: All players are ready!&quot;, roomID);</b>
&nbsp;        }
<b class="fc">&nbsp;        this.simpMessagingTemplate.convertAndSend(&quot;/topic/multi/rooms/&quot;+roomID+&quot;/info&quot;,updatedRoom);</b>
&nbsp;
<b class="fc">&nbsp;    }</b>
&nbsp;
&nbsp;    /**
&nbsp;     * It is used for update status when players play the game
&nbsp;     * start the game: Set isWriting=true;
&nbsp;     * submit a question: set isWriting=false;
&nbsp;     * When all players finished, reset isWriting=true, next question
&nbsp;     *
&nbsp;     * @throws Exception
&nbsp;     */
&nbsp;    @MessageMapping(&quot;/multi/rooms/{roomID}/players/gaming&quot;)
&nbsp;    public void updatePlayerWriting(@DestinationVariable int roomID, PlayerStatusDTO playerStatusDTO) {
<b class="fc">&nbsp;        log.info(&quot;Room {}: Player {} is changing the status.&quot;, roomID, playerStatusDTO.getUserID());</b>
<b class="fc">&nbsp;        Player updatedPlayer = this.gameService.updatePlayerStatusWriting(roomID, playerStatusDTO);</b>
&nbsp;
<b class="fc">&nbsp;        Room updatedRoom = this.gameService.findRoomByID(roomID);</b>
<b class="fc">&nbsp;        log.info(&quot;Updated room after player is ready: &quot; + updatedRoom.getRoomID());</b>
<b class="fc">&nbsp;        this.simpMessagingTemplate.convertAndSend(&quot;/topic/multi/rooms/&quot;+roomID+&quot;/info&quot;,updatedRoom);</b>
&nbsp;
&nbsp;        // When this question ends, reset the isWriting = ture
<b class="fc">&nbsp;        boolean finishIndicator = this.gameService.checkALlFinish(roomID);</b>
<b class="fc">&nbsp;        if(finishIndicator == true){</b>
<b class="fc">&nbsp;            this.gameService.nextQuestion(roomID);</b>
&nbsp;
<b class="fc">&nbsp;            log.info(&quot;Room {}: All players finish! &quot; + roomID);</b>
<b class="fc">&nbsp;            this.simpMessagingTemplate.convertAndSend(&quot;/topic/multi/rooms/&quot;+roomID+&quot;/info&quot;,updatedRoom);</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;    }</b>
&nbsp;
&nbsp;    /**
&nbsp;     * Accumulate player scoreBoard (includes system score and votedScore) after each question and share ranking
&nbsp;     * After 1 pack (10 questions) finished, save the game record of each player(user) into DB
&nbsp;     *
&nbsp;     *  playerDTO.userId are required for searching
&nbsp;     *
&nbsp;     * @return true/ false
&nbsp;     * @throws Exception
&nbsp;     */
&nbsp;    @MessageMapping(&quot;/multi/rooms/{roomID}/players/scoreBoard&quot;)
&nbsp;    public void updatePlayerScoreBoard(@DestinationVariable int roomID, PlayerScoreBoardDTO playerScoreBoardDTO) {
<b class="fc">&nbsp;        log.info(&quot;Room {}: Player score {} is changing.&quot;, roomID, playerScoreBoardDTO.getScoreBoard().getSystemScore());</b>
<b class="fc">&nbsp;        this.gameService.updatePlayerScore(roomID, playerScoreBoardDTO);</b>
&nbsp;
<b class="fc">&nbsp;        Room updatedRoom = this.gameService.findRoomByID(roomID);</b>
<b class="fc">&nbsp;        log.info(&quot;Updated room with player score {} : &quot; + updatedRoom);</b>
<b class="fc">&nbsp;        this.simpMessagingTemplate.convertAndSend(&quot;/topic/multi/rooms/&quot;+roomID+&quot;/info&quot;,updatedRoom);</b>
&nbsp;
<b class="fc">&nbsp;    }</b>
&nbsp;
&nbsp;    /**
&nbsp;     * Retrieve players score after each question and share ranking
&nbsp;     * playerDTO.userId is required for searching
&nbsp;     *
&nbsp;     * @return true/ false
&nbsp;     * @throws Exception
&nbsp;     */
&nbsp;    @MessageMapping(&quot;/multi/rooms/{roomID}/players/scores&quot;)
&nbsp;    public void getPlayerScoreBoard(@DestinationVariable int roomID) {
<b class="fc">&nbsp;        log.info(&quot;Room {} is retrieving players score.&quot;, roomID);</b>
<b class="fc">&nbsp;        Map&lt;String, Integer&gt; playerRank =  this.gameService.calculateRanking(roomID);</b>
<b class="fc">&nbsp;        this.simpMessagingTemplate.convertAndSend(&quot;/topic/multi/rooms/&quot;+roomID+&quot;/scores&quot;, playerRank);</b>
<b class="fc">&nbsp;    }</b>
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2023-04-27 20:49</div>
</div>
</body>
</html>
